<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBIT Connect</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Verdana, Arial, Helvetica, sans-serif;
            font-size: 11px;
            background-color: #ffffff;
            color: #333333;
        }

        .header {
            background-color: #af2617;
            padding: 8px 12px;
            border-bottom: 1px solid #e12424;
        }

        .header-content {
            max-width: 950px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            color: #ffffff;
            font-size: 22px;
            font-weight: bold;
            text-decoration: none;
        }

        .header-links {
            display: flex;
            gap: 15px;
        }

        .header-links a {
            color: #ffffff;
            text-decoration: none;
            font-size: 11px;
        }

        .header-links a:hover {
            text-decoration: underline;
        }

        .user-name {
            color: #ffffff;
            font-weight: bold;
            margin-right: 10px;
        }

        .mode-badge {
            background: #fff;
            color: #af2617;
            padding: 2px 6px;
            font-size: 9px;
            border-radius: 3px;
            font-weight: bold;
        }

        .login-page {
            background-color: #ffffff;
            padding: 40px 20px;
        }

        .login-container {
            max-width: 450px;
            margin: 60px auto;
            background: #ffffff;
            border: 1px solid #cccccc;
            padding: 20px;
        }

        .login-container h1 {
            color: #3B5998;
            font-size: 18px;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .login-container .subtitle {
            color: #666666;
            font-size: 11px;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .form-row {
            margin-bottom: 10px;
        }

        .form-row label {
            display: block;
            color: #333333;
            font-size: 11px;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .form-row input,
        .form-row select,
        .form-row textarea {
            width: 100%;
            padding: 3px 4px;
            border: 1px solid #999999;
            font-size: 11px;
            font-family: Verdana, Arial, sans-serif;
            background: #ffffff;
        }

        .form-row input:focus,
        .form-row select:focus,
        .form-row textarea:focus {
            outline: none;
            border-color: #3B5998;
        }

        .form-row textarea {
            resize: vertical;
            min-height: 60px;
        }

        .btn {
            padding: 3px 8px;
            background-color: #3B5998;
            color: #ffffff;
            border: 1px solid #133783;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            font-family: Verdana, Arial, sans-serif;
        }

        .btn:hover {
            background-color: #2E4A86;
        }

        .btn:active {
            background-color: #133783;
        }

        .btn:disabled {
            background-color: #cccccc;
            border-color: #999999;
            cursor: not-allowed;
        }

        .btn-small {
            padding: 2px 6px;
            font-size: 10px;
        }

        .link-btn {
            background: none;
            border: none;
            color: #3B5998;
            text-decoration: underline;
            cursor: pointer;
            font-size: 11px;
            padding: 0;
        }

        .link-btn:hover {
            color: #2E4A86;
        }

        .auth-switch {
            margin-top: 15px;
            font-size: 11px;
            color: #666666;
        }

        .container {
            max-width: 950px;
            margin: 0 auto;
            padding: 10px;
        }

        .layout {
            display: table;
            width: 100%;
            border-collapse: collapse;
        }

        .sidebar {
            display: table-cell;
            width: 200px;
            vertical-align: top;
            padding-right: 10px;
        }

        .main-content {
            display: table-cell;
            vertical-align: top;
            padding-left: 10px;
            border-left: 1px solid #cccccc;
        }

        .sidebar-box {
            background: #f7f7f7;
            border: 1px solid #cccccc;
            margin-bottom: 10px;
            padding: 8px;
        }

        .sidebar-box h3 {
            color: #3B5998;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid #dddddd;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            padding: 4px 0;
            font-size: 11px;
            cursor: pointer;
        }

        .sidebar-menu li a {
            color: #3B5998;
            text-decoration: none;
        }

        .sidebar-menu li a:hover {
            text-decoration: underline;
        }

        .sidebar-menu li.active a {
            font-weight: bold;
        }

        .content-box {
            background: #ffffff;
            border: 1px solid #cccccc;
            margin-bottom: 10px;
            padding: 10px;
        }

        .content-box h2 {
            color: #3B5998;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid #dddddd;
        }

        .content-box .subtitle {
            color: #666666;
            font-size: 11px;
            margin-bottom: 12px;
        }

        .filter-bar {
            background: #f7f7f7;
            border: 1px solid #cccccc;
            padding: 8px;
            margin-bottom: 10px;
        }

        .filter-bar label {
            margin-right: 5px;
            font-weight: bold;
        }

        .filter-bar select {
            padding: 2px 4px;
            border: 1px solid #999999;
            font-size: 11px;
            margin-right: 10px;
        }

        .post-item {
            background: #f7f7f7;
            border: 1px solid #cccccc;
            margin-bottom: 8px;
            padding: 8px;
        }

        .post-item h3 {
            color: #3B5998;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .post-item .meta {
            color: #666666;
            font-size: 10px;
            margin-bottom: 6px;
        }

        .post-item .info {
            color: #333333;
            font-size: 11px;
            margin: 4px 0;
            line-height: 1.4;
        }

        .post-item .skills {
            margin: 6px 0;
        }

        .skill {
            display: inline;
            background: #e3e8f0;
            padding: 2px 5px;
            margin-right: 4px;
            font-size: 10px;
            color: #3B5998;
        }

        .post-item .contact {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #dddddd;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .post-item .contact a {
            color: #3B5998;
            text-decoration: none;
            font-size: 11px;
        }

        .post-item .contact a:hover {
            text-decoration: underline;
        }

        .status {
            display: inline-block;
            color: #ffffff;
            padding: 2px 5px;
            font-size: 9px;
            font-weight: bold;
            text-transform: uppercase;
            margin-left: 5px;
        }

        .status-hackathon { background: #6d9e31; }
        .status-startup { background: #ff6b35; }
        .status-project { background: #4ecdc4; }
        .status-event { background: #9b59b6; }

        .message {
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid;
            font-size: 11px;
        }

        .message-success {
            background: #e8f5e9;
            border-color: #4caf50;
            color: #2e7d32;
        }

        .message-error {
            background: #ffebee;
            border-color: #f44336;
            color: #c62828;
        }

        .message-info {
            background: #e3f2fd;
            border-color: #2196f3;
            color: #1565c0;
        }

        .message-warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .empty {
            text-align: center;
            padding: 30px;
            color: #999999;
            font-size: 11px;
        }

        .empty-icon {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666666;
        }

        .hidden {
            display: none !important;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #999999;
            font-size: 10px;
            border-top: 1px solid #cccccc;
            margin-top: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: #ffffff;
            border: 2px solid #3B5998;
            padding: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            color: #3B5998;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #dddddd;
        }

        .modal-body {
            margin: 10px 0;
            font-size: 11px;
            line-height: 1.4;
        }

        .modal-footer {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #dddddd;
            text-align: right;
        }

        .modal-footer .btn {
            margin-left: 5px;
        }

        .tab-bar {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            border-bottom: 2px solid #cccccc;
        }

        .tab {
            padding: 5px 12px;
            background: #f7f7f7;
            border: 1px solid #cccccc;
            border-bottom: none;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            color: #666666;
        }

        .tab:hover {
            background: #eeeeee;
        }

        .tab.active {
            background: #ffffff;
            color: #3B5998;
            border-bottom: 2px solid #ffffff;
            margin-bottom: -2px;
        }

        @media (max-width: 768px) {
            .layout {
                display: block;
            }
            
            .sidebar, .main-content {
                display: block;
                width: 100%;
                padding: 0;
                border: none;
            }
            
            .sidebar {
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Section -->
    <div id="authSection">
        <!-- Login -->
        <div id="loginPage" class="login-page">
            <div class="login-container">
                <h1>CBIT Connect</h1>
                <p class="subtitle">
                    Connect with CBIT students for hackathons, startups, projects, and tech events.
                </p>
                
                <div id="loginMessage"></div>
                
                <div class="form-row">
                    <label>Email:</label>
                    <input type="email" id="loginEmail" placeholder="yourname@cbit.ac.in">
                </div>
                <div class="form-row">
                    <label>Password:</label>
                    <input type="password" id="loginPassword">
                </div>
                <div class="form-row">
                    <button class="btn" type="button" id="loginBtn" onclick="handleLogin()">Login</button>
                </div>
                
                <div class="auth-switch">
                    Don't have an account? <button class="link-btn" onclick="switchToSignup()">Sign Up</button>
                </div>
            </div>
        </div>

        <!-- Signup -->
        <div id="signupPage" class="login-page hidden">
            <div class="login-container">
                <h1>Join CBIT Connect</h1>
                <p class="subtitle">
                    Create your account and start collaborating.
                </p>
                
                <div id="signupMessage"></div>
                
                <div class="form-row">
                    <label>Name:</label>
                    <input type="text" id="signupName" placeholder="Full Name">
                </div>
                <div class="form-row">
                    <label>Email:</label>
                    <input type="email" id="signupEmail" placeholder="yourname@cbit.ac.in">
                </div>
                <div class="form-row">
                    <label>Password:</label>
                    <input type="password" id="signupPassword" placeholder="Min 6 characters">
                </div>
                <div class="form-row">
                    <button class="btn" type="button" id="signupBtn" onclick="handleSignup()">Sign Up</button>
                </div>
                
                <div class="auth-switch">
                    Already have an account? <button class="link-btn" onclick="switchToLogin()">Login</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <a href="#" class="logo" onclick="navigateTo('discover'); return false;">
                    CBIT Connect 
                    <span class="mode-badge" id="modeBadge">LIVE</span>
                </a>
                <div class="header-links">
                    <span class="user-name" id="headerUserName"></span>
                    <a href="#" onclick="navigateTo('discover'); return false;">discover</a>
                    <a href="#" onclick="navigateTo('profile'); return false;">profile</a>
                    <a href="#" onclick="openCreatePostModal(); return false;">+ create post</a>
                    <a href="#" onclick="handleLogout(); return false;">logout</a>
                </div>
            </div>
        </div>

        <!-- Main Container -->
        <div class="container">
            <div class="layout">
                <!-- Sidebar -->
                <div class="sidebar">
                    <div class="sidebar-box">
                        <h3>Navigation</h3>
                        <ul class="sidebar-menu">
                            <li id="menuDiscover" class="active"><a href="#" onclick="navigateTo('discover'); return false;">Discover</a></li>
                            <li id="menuMyPosts"><a href="#" onclick="navigateTo('myposts'); return false;">My Posts</a></li>
                            <li id="menuProfile"><a href="#" onclick="navigateTo('profile'); return false;">Profile</a></li>
                        </ul>
                    </div>

                    <div class="sidebar-box">
                        <h3>Quick Stats</h3>
                        <p style="font-size: 10px; color: #666; line-height: 1.4;">
                            Active Posts: <strong id="statsActive">0</strong><br>
                            Total Users: <strong id="statsUsers">0</strong>
                        </p>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="main-content">
                    <!-- Discover Page -->
                    <div id="discoverPage">
                        <div class="content-box">
                            <h2>Discover Opportunities</h2>
                            <p class="subtitle">Find teammates, co-founders, and collaborators at CBIT</p>
                            
                            <!-- Tabs -->
                            <div class="tab-bar">
                                <div class="tab active" onclick="filterByType('all')">All</div>
                                <div class="tab" onclick="filterByType('hackathon')">Hackathons</div>
                                <div class="tab" onclick="filterByType('startup')">Startups</div>
                                <div class="tab" onclick="filterByType('project')">Projects</div>
                                <div class="tab" onclick="filterByType('event')">Events</div>
                            </div>

                            <!-- Filter Bar -->
                            <div class="filter-bar">
                                <label>Year:</label>
                                <select id="yearFilter" onchange="applyFilters()">
                                    <option value="">All Years</option>
                                    <option value="1">1st Year</option>
                                    <option value="2">2nd Year</option>
                                    <option value="3">3rd Year</option>
                                    <option value="4">4th Year</option>
                                </select>
                                <button class="btn btn-small" onclick="loadAllPosts()">🔄 Refresh</button>
                            </div>
                            
                            <div id="postsList">
                                <div class="loading">Loading posts...</div>
                            </div>
                        </div>
                    </div>

                    <!-- My Posts Page -->
                    <div id="myPostsPage" class="hidden">
                        <div class="content-box">
                            <h2>My Posts</h2>
                            <p class="subtitle">Manage your collaboration requests</p>
                            
                            <div id="myPostsList">
                                <div class="loading">Loading your posts...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Page -->
                    <div id="profilePage" class="hidden">
                        <div class="content-box">
                            <h2>My Profile</h2>
                            <p class="subtitle">Edit your profile information</p>

                            <div id="profileMessage"></div>
                            
                            <div class="form-row">
                                <label>Name:</label>
                                <input type="text" id="profileName">
                            </div>

                            <div class="form-row">
                                <label>Year:</label>
                                <select id="profileYear">
                                    <option value="1">1st Year</option>
                                    <option value="2">2nd Year</option>
                                    <option value="3">3rd Year</option>
                                    <option value="4">4th Year</option>
                                </select>
                            </div>

                            <div class="form-row">
                                <label>Branch:</label>
                                <select id="profileBranch">
                                    <option>CSE</option>
                                    <option>IT</option>
                                    <option>ECE</option>
                                    <option>EEE</option>
                                    <option>MECH</option>
                                    <option>CIVIL</option>
                                </select>
                            </div>

                            <div class="form-row">
                                <label>Skills (comma separated):</label>
                                <input type="text" id="profileSkills" placeholder="React, Python, UI/UX, Node.js">
                            </div>

                            <div class="form-row">
                                <label>About:</label>
                                <textarea id="profileBio" placeholder="Tell others about yourself..."></textarea>
                            </div>

                            <div class="form-row">
                                <label>WhatsApp Number:</label>
                                <input type="tel" id="profileWhatsapp" placeholder="9876543210">
                            </div>

                            <div class="form-row">
                                <button class="btn" type="button" onclick="saveProfile()">Update Profile</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="footer">
                CBIT Connect &copy; 2025 | <span id="footerMode">Live Mode - Powered by Supabase</span>
            </div>
        </div>
    </div>

    <!-- Create Post Modal -->
    <div id="createPostModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Create New Post</div>
            <div class="modal-body">
                <div id="createPostMessage"></div>
                
                <div class="form-row">
                    <label>What are you looking for?</label>
                    <select id="postType">
                        <option value="hackathon">Hackathon Teammate</option>
                        <option value="startup">Startup Co-founder</option>
                        <option value="project">Project Collaborator</option>
                        <option value="event">Event Partner</option>
                    </select>
                </div>

                <div class="form-row">
                    <label>Title:</label>
                    <input type="text" id="postTitle" placeholder="e.g., Looking for React developer for hackathon">
                </div>

                <div class="form-row">
                    <label>Description:</label>
                    <textarea id="postDescription" placeholder="Describe what you're looking for..."></textarea>
                </div>

                <div class="form-row">
                    <label>Required Skills (comma separated):</label>
                    <input type="text" id="postSkills" placeholder="React, Node.js, UI/UX">
                </div>

                <div class="form-row">
                    <label>Duration (hours):</label>
                    <select id="postDuration">
                        <option value="1">1 hour</option>
                        <option value="3">3 hours</option>
                        <option value="6">6 hours</option>
                        <option value="12">12 hours</option>
                        <option value="24">24 hours</option>
                    </select>
                    <p style="font-size: 10px; color: #666; margin-top: 3px;">Post will auto-delete after this duration</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-small" onclick="closeCreatePostModal()">Cancel</button>
                <button class="btn btn-small" onclick="createPost()">Create Post</button>
            </div>
        </div>
    </div>

    <!-- Contact Modal -->
    <div id="contactModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Contact User</div>
            <div class="modal-body">
                <p>When you contact this person, your active posts will automatically be marked as inactive.</p>
                <p style="margin-top: 8px;"><strong>Continue to WhatsApp?</strong></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-small" onclick="closeContactModal()">Cancel</button>
                <button class="btn btn-small" onclick="confirmContact()">Continue</button>
            </div>
        </div>
    </div>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // ============================================
        // CONFIGURE YOUR SUPABASE CREDENTIALS HERE
        // ============================================
        const SUPABASE_URL = 'https://yrjdceazbyapzninojdd.supabase.co';  // e.g., 'https://xxxxx.supabase.co'
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlyamRjZWF6YnlhcHpuaW5vamRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2ODE4NzksImV4cCI6MjA3NTI1Nzg3OX0.cv27XRItKhZVp9r3rvJTFv7ekA4KVhto7MGfJiO7JiQ';  // Your anon/public key
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let currentFilter = 'all';
        let pendingWhatsAppUrl = null;

        // Initialize
        async function initApp() {
            checkAuth();
        }

        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (session) {
                currentUser = session.user;
                showMainApp();
            } else {
                showAuth();
            }
        }

        function showAuth() {
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        async function showMainApp() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            // Load profile to get name
            const { data: profile } = await supabase
                .from('profiles')
                .select('name')
                .eq('id', currentUser.id)
                .single();
            
            const displayName = profile?.name || currentUser.email.split('@')[0];
            document.getElementById('headerUserName').textContent = displayName;
            
            loadUserProfile();
            loadAllPosts();
            updateStats();
        }

        function switchToSignup() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('signupPage').classList.remove('hidden');
        }

        function switchToLogin() {
            document.getElementById('signupPage').classList.add('hidden');
            document.getElementById('loginPage').classList.remove('hidden');
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const msgEl = document.getElementById('loginMessage');

            if (!email || !password) {
                msgEl.innerHTML = '<div class="message message-error">Please enter both email and password</div>';
                return;
            }

            if (!email.endsWith('@cbit.ac.in')) {
                msgEl.innerHTML = '<div class="message message-error">Please use your CBIT email (@cbit.ac.in)</div>';
                return;
            }

            const { data, error } = await supabase.auth.signInWithPassword({
                email,
                password
            });

            if (error) {
                msgEl.innerHTML = `<div class="message message-error">${error.message}</div>`;
            } else {
                currentUser = data.user;
                showMainApp();
            }
        }

        async function handleSignup() {
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const msgEl = document.getElementById('signupMessage');

            if (!name || !email || !password) {
                msgEl.innerHTML = '<div class="message message-error">Please fill all fields</div>';
                return;
            }

            if (!email.endsWith('@cbit.ac.in')) {
                msgEl.innerHTML = '<div class="message message-error">Please use your CBIT email (@cbit.ac.in)</div>';
                return;
            }

            if (password.length < 6) {
                msgEl.innerHTML = '<div class="message message-error">Password must be at least 6 characters</div>';
                return;
            }

            const { data, error } = await supabase.auth.signUp({
                email,
                password
            });

            if (error) {
                msgEl.innerHTML = `<div class="message message-error">${error.message}</div>`;
                return;
            }

            // Create profile
            const { error: profileError } = await supabase
                .from('profiles')
                .insert({
                    id: data.user.id,
                    email: email,
                    name: name
                });

            if (profileError) {
                console.error('Profile creation error:', profileError);
            }

            currentUser = data.user;
            showMainApp();
        }

        async function handleLogout() {
            if (confirm('Logout?')) {
                await supabase.auth.signOut();
                location.reload();
            }
        }

        function navigateTo(page) {
            document.getElementById('discoverPage').classList.add('hidden');
            document.getElementById('myPostsPage').classList.add('hidden');
            document.getElementById('profilePage').classList.add('hidden');

            document.querySelectorAll('.sidebar-menu li').forEach(li => li.classList.remove('active'));

            if (page === 'discover') {
                document.getElementById('discoverPage').classList.remove('hidden');
                document.getElementById('menuDiscover').classList.add('active');
                loadAllPosts();
            } else if (page === 'myposts') {
                document.getElementById('myPostsPage').classList.remove('hidden');
                document.getElementById('menuMyPosts').classList.add('active');
                loadMyPosts();
            } else if (page === 'profile') {
                document.getElementById('profilePage').classList.remove('hidden');
                document.getElementById('menuProfile').classList.add('active');
                loadUserProfile();
            }
        }

        async function loadUserProfile() {
            const { data: profile } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();

            if (profile) {
                document.getElementById('profileName').value = profile.name || '';
                document.getElementById('profileYear').value = profile.year || '1';
                document.getElementById('profileBranch').value = profile.branch || 'CSE';
                document.getElementById('profileSkills').value = profile.skills || '';
                document.getElementById('profileBio').value = profile.bio || '';
                document.getElementById('profileWhatsapp').value = profile.whatsapp || '';
            }
        }

        async function saveProfile() {
            const profile = {
                name: document.getElementById('profileName').value.trim(),
                year: parseInt(document.getElementById('profileYear').value),
                branch: document.getElementById('profileBranch').value,
                skills: document.getElementById('profileSkills').value.trim(),
                bio: document.getElementById('profileBio').value.trim(),
                whatsapp: document.getElementById('profileWhatsapp').value.trim(),
                email: currentUser.email
            };

            if (!profile.name) {
                alert('Please enter your name');
                return;
            }

            const { error } = await supabase
                .from('profiles')
                .upsert({
                    id: currentUser.id,
                    ...profile
                });

            if (error) {
                console.error('Profile update error:', error);
                alert('Error updating profile');
                return;
            }

            const msg = document.getElementById('profileMessage');
            msg.innerHTML = '<div class="message message-success">Profile updated!</div>';
            setTimeout(() => msg.innerHTML = '', 3000);
            
            document.getElementById('headerUserName').textContent = profile.name;
        }

        async function openCreatePostModal() {
            const { data: profile } = await supabase
                .from('profiles')
                .select('whatsapp')
                .eq('id', currentUser.id)
                .single();

            if (!profile || !profile.whatsapp) {
                alert('Please complete your profile (including WhatsApp number) before creating posts.');
                navigateTo('profile');
                return;
            }

            document.getElementById('createPostModal').classList.add('show');
        }

        function closeCreatePostModal() {
            document.getElementById('createPostModal').classList.remove('show');
            document.getElementById('postTitle').value = '';
            document.getElementById('postDescription').value = '';
            document.getElementById('postSkills').value = '';
            document.getElementById('createPostMessage').innerHTML = '';
        }

        async function createPost() {
            const { data: profile } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();

            const title = document.getElementById('postTitle').value.trim();
            const description = document.getElementById('postDescription').value.trim();
            const skills = document.getElementById('postSkills').value.trim();
            const type = document.getElementById('postType').value;
            const duration = parseInt(document.getElementById('postDuration').value);

            if (!title || !description) {
                document.getElementById('createPostMessage').innerHTML = '<div class="message message-error">Please fill in title and description</div>';
                return;
            }

            const expiresAt = new Date(Date.now() + (duration * 60 * 60 * 1000)).toISOString();

            const { error } = await supabase
                .from('posts')
                .insert({
                    user_id: currentUser.id,
                    user_email: currentUser.email,
                    user_name: profile.name,
                    user_year: profile.year,
                    user_branch: profile.branch,
                    user_whatsapp: profile.whatsapp,
                    title,
                    description,
                    skills,
                    type,
                    expires_at: expiresAt,
                    active: true
                });

            if (error) {
                console.error('Post creation error:', error);
                alert('Error creating post');
                return;
            }

            closeCreatePostModal();
            loadAllPosts();
            updateStats();

            alert('Post created successfully!');
        }

        function filterByType(type) {
            currentFilter = type;
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            applyFilters();
        }

        function applyFilters() {
            loadAllPosts();
        }

        async function loadAllPosts() {
            const container = document.getElementById('postsList');
            container.innerHTML = '<div class="loading">Loading posts...</div>';

            const yearFilter = document.getElementById('yearFilter')?.value || '';

            let query = supabase
                .from('posts')
                .select('*')
                .eq('active', true)
                .neq('user_id', currentUser.id)
                .gt('expires_at', new Date().toISOString())
                .order('created_at', { ascending: false });

            if (currentFilter !== 'all') {
                query = query.eq('type', currentFilter);
            }

            if (yearFilter) {
                query = query.eq('user_year', parseInt(yearFilter));
            }

            const { data: posts, error } = await query;

            if (error) {
                console.error('Error loading posts:', error);
                container.innerHTML = '<div class="empty"><p>Error loading posts</p></div>';
                return;
            }

            container.innerHTML = '';

            if (!posts || posts.length === 0) {
                container.innerHTML = `
                    <div class="empty">
                        <div class="empty-icon">📭</div>
                        <p><strong>No posts found.</strong></p>
                        <p>Check back later or adjust your filters!</p>
                    </div>
                `;
                return;
            }

            posts.forEach(post => {
                const skills = post.skills ? post.skills.split(',').map(s => s.trim()).filter(s => s) : [];
                const skillsHTML = skills.map(s => `<span class="skill">${s}</span>`).join(' ');

                const timeLeft = Math.max(0, new Date(post.expires_at) - Date.now());
                const hoursLeft = Math.floor(timeLeft / (60 * 60 * 1000));
                const minutesLeft = Math.floor((timeLeft % (60 * 60 * 1000)) / (60 * 1000));

                const div = document.createElement('div');
                div.className = 'post-item';
                div.innerHTML = `
                    <h3>
                        ${post.title}
                        <span class="status status-${post.type}">${post.type}</span>
                    </h3>
                    <div class="meta">
                        Posted by ${post.user_name} • ${post.user_year}${getYearSuffix(post.user_year)} Year ${post.user_branch} • 
                        Expires in ${hoursLeft}h ${minutesLeft}m
                    </div>
                    <div class="info">${post.description}</div>
                    ${skills.length > 0 ? `<div class="skills"><strong>Looking for:</strong> ${skillsHTML}</div>` : ''}
                    <div class="contact">
                        <a href="#" onclick="openContactModal('https://wa.me/91${post.user_whatsapp}', ${post.id}); return false;">[contact on whatsapp]</a>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        async function loadMyPosts() {
            const container = document.getElementById('myPostsList');
            container.innerHTML = '<div class="loading">Loading your posts...</div>';

            const { data: posts, error } = await supabase
                .from('posts')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading posts:', error);
                container.innerHTML = '<div class="empty"><p>Error loading your posts</p></div>';
                return;
            }

            container.innerHTML = '';

            if (!posts || posts.length === 0) {
                container.innerHTML = `
                    <div class="empty">
                        <div class="empty-icon">📝</div>
                        <p><strong>You haven't created any posts yet.</strong></p>
                        <p><button class="btn" onclick="openCreatePostModal()">Create Your First Post</button></p>
                    </div>
                `;
                return;
            }

            posts.forEach(post => {
                const skills = post.skills ? post.skills.split(',').map(s => s.trim()).filter(s => s) : [];
                const skillsHTML = skills.map(s => `<span class="skill">${s}</span>`).join(' ');

                const timeLeft = Math.max(0, new Date(post.expires_at) - Date.now());
                const hoursLeft = Math.floor(timeLeft / (60 * 60 * 1000));
                const minutesLeft = Math.floor((timeLeft % (60 * 60 * 1000)) / (60 * 1000));

                const isExpired = new Date(post.expires_at) <= new Date();

                const div = document.createElement('div');
                div.className = 'post-item';
                div.innerHTML = `
                    <h3>
                        ${post.title}
                        <span class="status status-${post.type}">${post.type}</span>
                        ${!post.active || isExpired ? '<span class="status" style="background: #999;">inactive</span>' : ''}
                    </h3>
                    <div class="meta">
                        ${post.active && !isExpired ? `Expires in ${hoursLeft}h ${minutesLeft}m` : 'Post is inactive'}
                    </div>
                    <div class="info">${post.description}</div>
                    ${skills.length > 0 ? `<div class="skills"><strong>Skills:</strong> ${skillsHTML}</div>` : ''}
                    <div class="contact">
                        ${post.active && !isExpired ? `<button class="btn btn-small" onclick="deactivatePost(${post.id})">Mark as Inactive</button>` : ''}
                        <button class="btn btn-small" onclick="deletePost(${post.id})">Delete</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        async function deactivatePost(postId) {
            const { error } = await supabase
                .from('posts')
                .update({ active: false })
                .eq('id', postId);

            if (error) {
                console.error('Error deactivating post:', error);
                alert('Error deactivating post');
                return;
            }

            loadMyPosts();
            updateStats();
        }

        async function deletePost(postId) {
            if (!confirm('Delete this post?')) return;

            const { error } = await supabase
                .from('posts')
                .delete()
                .eq('id', postId);

            if (error) {
                console.error('Error deleting post:', error);
                alert('Error deleting post');
                return;
            }

            loadMyPosts();
            updateStats();
        }

        function openContactModal(whatsappUrl, postId) {
            pendingWhatsAppUrl = whatsappUrl;
            document.getElementById('contactModal').classList.add('show');
        }

        function closeContactModal() {
            document.getElementById('contactModal').classList.remove('show');
            pendingWhatsAppUrl = null;
        }

        async function confirmContact() {
            if (pendingWhatsAppUrl) {
                // Deactivate all user's active posts
                const { error } = await supabase
                    .from('posts')
                    .update({ active: false })
                    .eq('user_id', currentUser.id)
                    .eq('active', true);

                if (error) {
                    console.error('Error deactivating posts:', error);
                }

                window.open(pendingWhatsAppUrl, '_blank');
                
                closeContactModal();
                updateStats();
                
                setTimeout(() => {
                    alert('Your active posts have been marked as inactive to avoid spam.');
                }, 500);
            }
        }

        async function updateStats() {
            const { count: activePosts } = await supabase
                .from('posts')
                .select('*', { count: 'exact', head: true })
                .eq('active', true)
                .gt('expires_at', new Date().toISOString());

            const { count: totalUsers } = await supabase
                .from('profiles')
                .select('*', { count: 'exact', head: true });

            document.getElementById('statsActive').textContent = activePosts || 0;
            document.getElementById('statsUsers').textContent = totalUsers || 0;
        }

        function getYearSuffix(year) {
            if (year == 1) return 'st';
            if (year == 2) return 'nd';
            if (year == 3) return 'rd';
            return 'th';
        }

        // Initialize app
        initApp();
    </script>
</body>
</html>
